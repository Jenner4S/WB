{"hidden":false,"children":[{"configs":{"itemId":"module"},"expanded":true,"children":[{"configs":{"layout":"absolute","itemId":"editWin","editWin":"true","width":"416","defaultFocus":"DEPT_NAME","height":"112"},"expanded":true,"children":[{"configs":{"allowBlank":"false","itemId":"DEPT_NAME","labelAlign":"right","fieldLabel":"* 部门名称","width":"376","x":"0","y":"16","height":"22"},"expanded":false,"children":[],"type":"text"}],"type":"window","events":{"ok":"var values = Wb.getValue(app.editWin);\nif (app.isEdit) {\n  Wb.request({\n    url: 'm?xwl=admin/dept/update',\n    params: Wb.applyIf(values, Wb.getData(app.selNode, true)),\n    success: function() {\n      values.text = values.DEPT_NAME;\n      Wb.update(app.selNode, values);\n      app.editWin.close();\n    }\n  });\n} else {\n  Wb.request({\n    url: 'm?xwl=admin/dept/insert',\n    out: app.editWin,\n    params: {\n      PARENT_DEPT: app.selNode.data.DEPT_ID,\n      ORDER_INDEX: app.selNode.lastChild ? app.selNode.lastChild.data.ORDER_INDEX + 1 : 1\n    },\n    success: function(resp) {\n      app.selNode.expand();\n      app.selNode.appendChild(Wb.apply({\n        iconCls: 'db_field_icon',\n        text: values.DEPT_NAME,\n        children: []\n      }, Wb.decode(resp.responseText))).commit();\n      app.editWin.close();\n    }\n  });\n}"}},{"configs":{"layout":"border","itemId":"viewport1"},"expanded":true,"children":[{"configs":{"itemId":"toolbar1","region":"north"},"expanded":true,"children":[{"configs":{"itemId":"newBtn","tooltip":"在当前节点下添加部门 (Ctrl+E)","text":"添加","iconCls":"record_add_icon"},"expanded":false,"children":[],"type":"item","events":{"click":"if (!app.selNode) {\n  Wb.warn('请选择 1 个部门。');\n  return;\n}\napp.editWin.setTitle('添加 - ' + app.selNode.data.text);\napp.editWin.setIconCls('record_add_icon');\napp.editWin.show();\napp.isEdit = false;"}},{"configs":{"itemId":"editBtn","tooltip":"修改选择的部门","text":"修改","iconCls":"record_edit_icon"},"expanded":false,"children":[],"type":"item","events":{"click":"if (!app.selNode) {\n  Wb.warn('请选择 1 个部门。');\n  return;\n}\nif (app.selNode.isRoot()) {\n  Wb.warn('不能对根节点进行修改。');\n  return;\n}\napp.editWin.setTitle('修改 - ' + app.selNode.data.text);\napp.editWin.setIconCls('record_edit_icon');\nWb.setValue(app.editWin, app.selNode.data);\napp.editWin.show();\napp.isEdit = true;"}},{"configs":{"itemId":"delBtn","tooltip":"删除选择的部门","text":"删除","iconCls":"record_delete_icon"},"expanded":false,"children":[],"type":"item","events":{"click":"if (app.tree1.selModel.isSelected(app.tree1.getRootNode())) {\n  Wb.warn('不能删除根节点。');\n  return;\n}\nWb.confirm('确定要删除选择的部门及其所属的所有子部门吗？', function() {\n  var deptIds = {};\n  Wb.each(app.tree1.getSelection(), function(node) {\n    node.cascadeBy(function(item) {\n      deptIds[item.data.DEPT_ID] = {\n        DEPT_ID: item.data.DEPT_ID\n      };\n    });\n  });\n  Wb.request({\n    url: 'm?xwl=admin/dept/delete',\n    params: {\n      deptIds: Ext.Object.getValues(deptIds)\n    },\n    success: function(resp) {\n      Wb.remove(app.tree1);\n    }\n  });\n});"}},{"configs":{"itemId":"item1","text":"-"},"expanded":false,"children":[],"type":"item"},{"configs":{"itemId":"refreshBtn","tooltip":"刷新部门列表","text":"刷新","iconCls":"refresh_icon"},"expanded":false,"children":[],"type":"item","events":{"click":"Wb.reload(app.tree1, null, {\n  field: 'DEPT_ID'\n});"}}],"type":"toolbar"},{"configs":{"itemId":"tree1","root":"{\n  text: '全部',\n  DEPT_ID: '-1',\n  expanded: true\n}","viewConfig":"app.treeViewConfig","region":"center","multiSelect":"true"},"expanded":true,"children":[{"configs":{"itemId":"store","fields":"['text', 'DEPT_NAME', 'DEPT_ID', 'PARENT_DEPT', 'ORDER_INDEX']","url":"m?xwl=admin/dept/select"},"expanded":false,"children":[],"type":"treestore","events":{"success":"Wb.selFirst(app.tree1);"}}],"type":"tree","events":{"selectionchange":"app.selNodes = selected;\napp.selNode = selected[0];","itemdblclick":"app.editBtn.fireEvent('click');"}}],"type":"viewport","events":{"afterrender":"app.navKey = new Ext.KeyNav({\n  viewport: app.viewport1,\n  E: {\n    ctrl: true,\n    fn: function() {\n      app.newBtn.fireEvent('click');\n    }\n  }\n});"}}],"type":"module","events":{"initialize":"Wb.apply(app, {\n  treeViewConfig: {\n    plugins: {\n      ptype: 'treeviewdragdrop'\n    },\n    listeners: {\n      beforedrop: function(node, data, om, dp, dh) {\n        var i, index, parentNode, parentDept, selDepts, deptCount = data.records.length;\n        if (dp == 'append') {\n          parentNode = om;\n          index = om.lastChild ? om.lastChild.data.ORDER_INDEX + 1 : 1;\n        } else {\n          parentNode = om.parentNode;\n          index = dp == 'before' ? om.data.ORDER_INDEX : om.data.ORDER_INDEX + 1;\n        }\n        dh.wait = true;\n        parentDept = parentNode.data.DEPT_ID;\n        selDepts = Wb.getData(data.records);\n        i = 0;\n        Wb.each(selDepts, function(item) {\n          item.ORDER_INDEX = index + (i++);\n        });\n        Wb.request({\n          url: 'm?xwl=admin/dept/move',\n          params: {\n            index: index,\n            deptCount: deptCount,\n            parentDept: parentDept,\n            selDepts: selDepts\n          },\n          callback: function(a, succ) {\n            if (succ) {\n              dh.processDrop();\n              parentNode.eachChild(function(node) {\n                i = node.data.ORDER_INDEX;\n                if (i >= index)\n                  node.set('ORDER_INDEX', i + deptCount);\n              });\n              i = 0;\n              Wb.each(data.records, function(node) {\n                node.set('PARENT_DEPT', parentDept);\n                node.set('ORDER_INDEX', index + (i++));\n              });\n              app.tree1.setSelection(data.records);\n            } else {\n              dh.cancelDrop();\n            }\n          }\n        });\n      }\n    }\n  }\n});"}}],"roles":{"demo":1},"title":"部门管理","iconCls":"org_icon","inframe":false,"pageLink":""}