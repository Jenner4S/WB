{"hidden":false,"children":[{"configs":{"serverScript":"var data = app.get(),\n  roles = ['default'],\n  depts = [],\n  userRoleRows = Wb.decode(data.roleGrid);\n\nif (data.USER_NAME.equals('-'))\n  Wb.error('无效的用户名。');\nif (data.USER_ID == 'admin' && !Wb.find(userRoleRows, 'ROLE_ID', 'admin')) {\n  Wb.error('不能取消默认管理员帐户的管理员权限。');\n}\napp.run('select 1 from WB_USER where USER_NAME={?USER_NAME?} and USER_ID<>{?USER_ID?}', {\n  errorText: '用户名称 \"' + data.USER_NAME + '\" 已经存在。'\n});\napp.set({\n  PASSWORD: Encrypter.getMD5(data.PASSWORD)\n});\napp.run('update WB_USER set USER_NAME={?nvarchar.USER_NAME?},DISPLAY_NAME={?nvarchar.DISPLAY_NAME?}' +\n  (data.PASSWORD.equals('******') ? '' : ',PASSWORD={?varchar.PASSWORD?}') +\n  ',STATUS={?numeric.STATUS?},EMAIL={?varchar.EMAIL?} where USER_ID={?varchar.#USER_ID?}', {\n    transaction: 'start'\n  }\n);\n\n//更新WB_USER_ROLE\napp.run('delete from WB_USER_ROLE where USER_ID={?USER_ID?}');\nWb.each(userRoleRows, function(rec) {\n  rec.USER_ID = data.USER_ID;\n  roles.push(rec.ROLE_ID);\n});\nrequest.setAttribute('create', Wb.encode(userRoleRows));\napp.update({\n  tableName: 'WB_USER_ROLE'\n});\n//更新WB_USER_DEPT\napp.run('delete from WB_USER_DEPT where USER_ID={?USER_ID?}');\nWb.each(Wb.decode(data.DEPT_IDS), function(rec) {\n  app.log(rec);\n  var userDepts = {};\n  userDepts.USER_ID = data.USER_ID;\n  userDepts.DEPT_ID = rec;\n  userDepts.CREATOR = app.get(\"sys.user\");\n  userDepts.CREATER_TIME = new JavaDate();\n  userDepts.UPDATOR = app.get(\"sys.user\");\n  userDepts.UPDATE_TIME = new JavaDate();\n  depts.push(userDepts);\n});\nrequest.setAttribute('create', Wb.encode(depts));\napp.update({\n  tableName: 'WB_USER_DEPT'\n});\n//更新session\ncom.wb.common.Session.updateSession(data.USER_ID, roles, data.STATUS == 1);","itemId":"module"},"expanded":true,"children":[],"type":"module"}],"roles":{},"title":"修改","iconCls":"","inframe":false,"pageLink":""}