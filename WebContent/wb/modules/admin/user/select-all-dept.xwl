{"hidden":true,"children":[{"configs":{"itemId":"module","serverScript":"var result = {},\n  records = {},\n  data = app.get(),\n  record, nodes, rs, meta;\n\nrs = app.run(\"select d.*,case when (select count(*) from wb_user_dept ud where ud.DEPT_ID=d.DEPT_ID  and ud.USER_ID ='\"+app.get(\"userId\")+\"')>0 then 'true' else 'false' end as checked from WB_DEPT d order by d.ORDER_INDEX\");\nmeta = rs.getMetaData();\nwhile (rs.next()) {\n  record = Wb.getRecord(rs, meta);\n  app.log(record);\n  Wb.apply(record, {\n    text: record.DEPT_NAME,\n    checked:record.checked\n  });\n  nodes = records[record.PARENT_DEPT];\n  if (nodes) {\n    nodes.push(record);\n  } else {\n    nodes = [record];\n    records[record.PARENT_DEPT] = nodes;\n  }\n}\n\nfunction createNodes(items, parentDept) {\n  items.children = records[parentDept] || [];\n  \n  if (items.children.length){\n    items.expanded = true;\n  }else{\n  \titems.leaf = true;\n  }\n    \n  Wb.each(items.children, function(item) {\n    createNodes(item, item.DEPT_ID);\n  });\n}\ncreateNodes(result, '-1');\napp.send(result);","description":"->数据类型自动转换：\nselect 'true' as \"leaf\"，由于leaf默认为布尔型，因此字符串'true'在客户端treeStore中可自动转换为布尔值true\nselect 'true' as \"checked\" 将自动在树节点前加复选框\n->数据类型指定类型转换：\nselect 'true' as \"myType\"，在DataProvider的fields属性中配置[{type:'boolean',name:'myType'}]，强制设置myType类型为布尔型\n\n/*select fullName as \"text\",regionCode,parentCode,0 as \"DONE_CHECK\",\ncase when (select count(*) from region b where b.parentCode=a.regionCode)>0 then 'false' else 'true' end as \"leaf\"\nfrom region a where parentCode={?parentCode?} order by regionType\n*/\n/*select DEPT_NAME as \"text\",DEPT_ID,PARENT_DEPT,\ncase when (select count(*) from wb_dept b where b.PARENT_DEPT=a.DEPT_ID)>0 then 'false' else 'true' end as \"leaf\",\ncase when (select count(*) from wb_user_dept ud where ud.DEPT_ID=a.DEPT_ID)>0 then 'true' else 'false' end as \"checked\"\nfrom wb_dept a where PARENT_DEPT={?parentDept?} order by ORDER_INDEX\n*/"},"expanded":true,"children":[],"type":"module"}],"roles":{"demo":1},"title":"部门树查询","iconCls":"","inframe":false,"pageLink":""}