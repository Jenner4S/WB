{"hidden":false,"children":[{"configs":{"serverScript":"var sql, userData, roleData, roleItem, roleObject, roleIdObject,\n    deptData, deptItem, deptObject, deptIdObject,params = app.get();\n\nsql = 'select USER_ID,USER_NAME,DISPLAY_NAME,EMAIL,\\'\\' as \"ROLES\",\\'\\' as \"ROLE_IDS\",\\'\\' as \"DEPTS\",\\'\\' as \"DEPT_IDS\",STATUS from WB_USER';\nif (!Wb.isEmpty(params.findCombo)) {\n  sql += ' where USER_NAME ={?findCombo?}';\n} else {\n  //按角色搜索\n  params.roles = Wb.decode(params.roles);\n  if (params.roles.length) {\n    var paramName, i = 0,\n      roleParams = [];\n    Wb.each(params.roles, function(role) {\n      paramName = 'role' + (i++);\n      app.set(paramName, role.ROLE_ID);\n      roleParams.push('{?' + paramName + '?}');\n    });\n    sql += ' where USER_ID in (select distinct USER_ID from WB_USER_ROLE where ROLE_ID in (' + roleParams + '))';\n  }\n  //按状态搜索\n  if (params.status) {\n    if (params.roles.length)\n      sql += ' and ';\n    else\n      sql += ' where ';\n    sql += 'STATUS={?integer.status?}';\n  }\n}\nsql += ' order by USER_NAME';\napp.log(sql);\nuserData = app.getData(sql, {\n  dictTableNames: 'WB_USER'\n});\n//查询获取的用户列表的角色数据\nroleData = Wb.getRecords(app.run(\"select a.USER_ID,a.ROLE_ID,b.ROLE_NAME from WB_USER_ROLE a, WB_ROLE b where a.ROLE_ID=b.ROLE_ID and a.USER_ID in ('\" + Wb.pluck(userData.rows, 'USER_ID').join(\"','\") + \"') order by a.USER_ID,a.ROLE_ID\"));\nroleObject = {};\nroleIdObject = {};\nWb.each(roleData, function(item) {\n  roleItem = roleObject[item.USER_ID];\n  if (!roleItem) {\n    roleItem = [];\n    roleObject[item.USER_ID] = roleItem;\n  }\n  roleItem.push(item.ROLE_NAME);\n  roleItem = roleIdObject[item.USER_ID];\n  if (!roleItem) {\n    roleItem = [];\n    roleIdObject[item.USER_ID] = roleItem;\n  }\n  roleItem.push(item.ROLE_ID);\n});\n//填充角色数据至用户数据\nWb.each(userData.rows, function(item) {\n  roleItem = roleObject[item.USER_ID];\n  item.ROLES = roleItem ? roleItem.join(', ') : null;\n  roleItem = roleIdObject[item.USER_ID];\n  item.ROLE_IDS = Wb.encode(roleItem || []);\n});\n\n//查询获取的用户列表的部门数据\ndeptData = Wb.getRecords(app.run(\"select USER_ID,USER_NAME,DEPT_ID,DEPT_NAME,PARENT_DEPT from view_dept_user where USER_ID in ('\" + Wb.pluck(userData.rows, 'USER_ID').join(\"','\") + \"') order by USER_ID,DEPT_ID\"));\ndeptObject = {};\ndeptIdObject = {};\nWb.each(deptData, function(item) {\n  deptItem = deptObject[item.USER_ID];\n  if (!deptItem) {\n    deptItem = [];\n    deptObject[item.USER_ID] = deptItem;\n  }\n  deptItem.push(item.DEPT_NAME);\n  deptItem = deptIdObject[item.USER_ID];\n  if (!deptItem) {\n    deptItem = [];\n    deptIdObject[item.USER_ID] = deptItem;\n  }\n  deptItem.push(item.DEPT_ID);\n});\n\n//填充部门数据至用户数据\nWb.each(userData.rows, function(item) {\n  deptItem = deptObject[item.USER_ID];\n  item.DEPTS = deptItem ? deptItem.join(', ') : null;\n  deptItem = deptIdObject[item.USER_ID];\n  item.DEPT_IDS = Wb.encode(deptItem || []);\n});\napp.send(userData);","itemId":"module"},"expanded":true,"children":[],"type":"module"}],"roles":{"demo":1},"title":"查询","iconCls":"","inframe":false,"pageLink":""}